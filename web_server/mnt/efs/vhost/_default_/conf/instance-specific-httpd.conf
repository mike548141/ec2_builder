# Add vhost name to log entries
LogFormat			"%v %h %l %u %t \"%r\" %>s %b" vhost_common
LogFormat			"%v %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" vhost_combinedio
LogFormat			"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b" ssl_request_log

# Default virtual host config that is specific to this instance for HTTP connections
<VirtualHost _default_:80>
  ServerName			i-instanceid.cakeit.nz
  ServerAlias			i-instanceid.cakeit.nz web2.cakeit.nz
  ServerAdmin			help@cakeit.nz
  DocumentRoot			"/mnt/efs/vhost/_default_/htdoc"
  
  <Directory /mnt/efs/vhost/_default_/htdoc>
    AllowOverride		None
    Require			all granted
  </Directory>
  
  RewriteEngine			on
  RewriteRule			^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
  #RewriteCond			%{SERVER_NAME} =i-instanceid.cakeit.nz
  #RewriteRule			^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
  
  #<IfModule !mod_php5.c>
  #  <IfModule !mod_php7.c>
      # Enable http authorization headers
  #    SetEnvIfNoCase		^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
  #    <FilesMatch \.(php|phar)$>
  #      SetHandler		"proxy:unix:/run/php-fpm/_default_.sock|fcgi://localhost"
  #    </FilesMatch>
  #  </IfModule>
  #</IfModule>
  
  #ErrorDocument			400 /error/400.html
  #ErrorDocument			401 /error/401.html
  #ErrorDocument			403 /error/403.html
  #ErrorDocument			404 /error/404.html
  #ErrorDocument			500 /error/500.html
  #ErrorDocument			501 /error/501.html
  #ErrorDocument			502 /error/502.html
  #ErrorDocument			503 /error/503.html
  
  LogLevel			warn
  CustomLog			/mnt/efs/vhost/_default_/log/i-instanceid.cakeit.nz/access_log combined
  ErrorLog			/mnt/efs/vhost/_default_/log/i-instanceid.cakeit.nz/error_log
</VirtualHost>

Listen				443 https
SSLPassPhraseDialog		exec:/usr/libexec/httpd-ssl-pass-dialog
SSLSessionCache			shmcb:/run/httpd/sslcache(512000)
SSLSessionCacheTimeout		300
SSLRandomSeed			startup file:/dev/urandom  256
SSLRandomSeed			connect builtin
SSLCryptoDevice			builtin
SSLStaplingCache		shmcb:/var/run/apache2/stapling_cache(128000)

# Default virtual host config for HTTPS connections
<VirtualHost _default_:443>
  ServerName			i-instanceid.cakeit.nz:443
  ServerAlias			i-instanceid.cakeit.nz web2.cakeit.nz
  ServerAdmin			help@cakeit.nz
  DocumentRoot			"/mnt/efs/vhost/_default_/htdoc"
  
  <Directory /mnt/efs/vhost/_default_/htdoc>
    AllowOverride		None
    Require			all granted
  </Directory>
  <Directory "/var/www/cgi-bin">
    SSLOptions			+StdEnvVars
  </Directory>
  
  SSLEngine			on
  SSLCertificateFile		/mnt/efs/vhost/_default_/pki/fullchain.pem
  SSLCertificateKeyFile		/mnt/efs/vhost/_default_/pki/privkey.pem
  #SSLCertificateChainFile	/mnt/efs/vhost/_default_/pki/chain.pem
  #SSLCACertificateFile		/mnt/efs/vhost/_default_/pki/ca-bundle.crt
  #SSLCertificateFile		/etc/letsencrypt/live/i-instanceid.cakeit.nz/fullchain.pem
  #SSLCertificateKeyFile		/etc/letsencrypt/live/i-instanceid.cakeit.nz/privkey.pem
  
  SSLProtocol			all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
  SSLCipherSuite		ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
  SSLHonorCipherOrder		on
  #SSLVerifyClient		require
  #SSLVerifyDepth		10
  SSLUseStapling		on
  SSLOptions			+StrictRequire
  
  Header			always set Strict-Transport-Security: "max-age=63072000; includeSubDomains; preload"
  Header			always set Content-Security-Policy: "frame-ancestors 'none'; upgrade-insecure-requests; default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self';"
  Header			set X-Frame-Options: DENY
  Header			set X-Content-Type-Options: nosniff
  Header			set Referrer-Policy: same-origin
  Header			set Feature-Policy: "vibrate 'self';"
  Header			edit Set-Cookie (?i)^(.*)(;\s*secure)??((\s*;)?(.*)) "$1; Secure$3$4"
  
  <Files ~ "\.(cgi|shtml|phtml|php3?)$">
    SSLOptions			+StdEnvVars
  </Files>
  
  BrowserMatch			"MSIE [2-5]"nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
  
  <IfModule !mod_php5.c>
    <IfModule !mod_php7.c>
      # Enable http authorization headers
      SetEnvIfNoCase		^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
      <FilesMatch \.(php|phar)$>
        SetHandler		"proxy:unix:/run/php-fpm/_default_.sock|fcgi://localhost"
      </FilesMatch>
    </IfModule>
  </IfModule>
  
  #ErrorDocument			400 /error/400.html
  #ErrorDocument			401 /error/401.html
  #ErrorDocument			403 /error/403.html
  #ErrorDocument			404 /error/404.html
  #ErrorDocument			500 /error/500.html
  #ErrorDocument			501 /error/501.html
  #ErrorDocument			502 /error/502.html
  #ErrorDocument			503 /error/503.html
  
  LogLevel			warn
  CustomLog			/mnt/efs/vhost/_default_/log/i-instanceid.cakeit.nz/ssl_request_log ssl_request_log
  TransferLog			/mnt/efs/vhost/_default_/log/i-instanceid.cakeit.nz/ssl_transfer_log
  ErrorLog			/mnt/efs/vhost/_default_/log/i-instanceid.cakeit.nz/ssl_error_log
</VirtualHost>
